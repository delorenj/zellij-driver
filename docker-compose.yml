# Docker Compose for Hybrid BMAD + Letta Architecture - Phase 1 Development Environment
# Event Store Infrastructure with PostgreSQL, RabbitMQ (Bloodbank), and Redis

version: '3.8'

services:
  # PostgreSQL Event Store
  postgres:
    image: postgres:16-alpine
    container_name: hybrid-arch-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=event_store
      - POSTGRES_USER=event_store
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # Performance optimizations for event store workload
      - POSTGRES_INITDB_ARGS=--auth-local=trust --auth-host=md5
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Init scripts for Phase 1 schema (will be created in STORY-001)
      - ./migrations:/docker-entrypoint-initdb.d
    ports:
      - "5435:5432"  # Using 5435 to avoid conflicts with other projects
    networks:
      - hybrid-arch
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.7
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=8MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_wal_senders=5
      -c wal_level=replica
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U event_store -d event_store"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # RabbitMQ (Bloodbank Event Bus)
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: hybrid-arch-rabbitmq
    restart: unless-stopped
    hostname: bloodbank-rabbitmq
    environment:
      # Authentication
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-bloodbank}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=/

      # Clustering (disabled for single-node dev)
      - RABBITMQ_ERLANG_COOKIE=${RABBITMQ_ERLANG_COOKIE:-bloodbank-secret-cookie}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      # Custom configuration
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    ports:
      - "5675:5672"   # AMQP protocol (using 5675 to avoid conflicts)
      - "15675:15672" # Management UI (using 15675 to avoid conflicts)
    networks:
      - hybrid-arch
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis (Cache and Real-time State)
  redis:
    image: redis:7-alpine
    container_name: hybrid-arch-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --tcp-backlog 511
      --timeout 300
      --databases 16
      --save 900 1 300 10 60 10000
      --rdbcompression yes
      --rdbchecksum yes
      --maxclients 10000
      --notify-keyspace-events AKE
    volumes:
      - redis_data:/data
    ports:
      - "6382:6379"  # Using 6382 to avoid conflicts with other projects
    networks:
      - hybrid-arch
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 2s
      retries: 3
      start_period: 5s

# Volumes for data persistence
volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  redis_data:
    driver: local

# Network for service communication
networks:
  hybrid-arch:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
